<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resuscitation App v2 - Step 1</title>
    <style>
        /* ========================================
           CSS VARIABLES
           ======================================== */
        :root {
            --app-width: 390px;
            --app-height: 844px;
            --header-h: 50px;
            --footer-h: 100px;
            --wheel-diameter: 300px;
            --card-width: 180px;
            --card-height: 210px;
            --knob-size: 30px;
            --preview-width: 140px;
            --preview-height: 90px;
            --history-width: 130px;
            --history-height: 80px;
            --primary: #111;
            --card-bg: #ffffff;
            --bg: #f5f5f5;
            --accent-red: #d32f2f;
        }

        /* ========================================
           BASE STYLES
           ======================================== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        /* ========================================
           APP CONTAINER
           ======================================== */
        #app {
            width: var(--app-width);
            height: var(--app-height);
            background: var(--bg);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }

        /* ========================================
           HEADER
           ======================================== */
        header {
            height: var(--header-h);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--primary);
            background: white;
            flex-shrink: 0;
        }
        .app-title { font-weight: 700; font-size: 14px; }
        .header-icons { display: flex; gap: 12px; align-items: center; }
        .header-icon { width: 22px; height: 22px; cursor: pointer; }

        /* ========================================
           STAGE (Main Play Area)
           ======================================== */
        #stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ========================================
           ZONE: TOP (Preview Stack)
           ======================================== */
        #zone-top {
            height: 140px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 8px;
        }

        /* ========================================
           ZONE: MIDDLE (Wheel + Active Card)
           ======================================== */
        #zone-middle {
            height: calc(var(--wheel-diameter) + 30px);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* The Wheel Circle */
        #wheel {
            width: var(--wheel-diameter);
            height: var(--wheel-diameter);
            border: 1px solid var(--primary);
            border-radius: 50%;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        /* Active Card - INSCRIBED inside wheel */
        #active-card {
            width: var(--card-width);
            height: var(--card-height);
            background: var(--card-bg);
            border: 2px solid var(--primary);
            border-radius: 8px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 10;
            overflow: hidden;
            padding: 12px;
        }

        /* Cover mode - transparent, no border */
        #active-card.cover-mode {
            background: transparent;
            border: none;
        }

        /* Loop mode - pulsing red */
        #active-card.loop-mode {
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
            50% { box-shadow: 0 8px 35px rgba(211, 47, 47, 0.4); border-color: var(--accent-red); }
        }

        /* The Knob */
        #knob {
            width: var(--knob-size);
            height: var(--knob-size);
            background: var(--primary);
            border-radius: 50%;
            position: absolute;
            z-index: 100;
            cursor: grab;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }
        #knob:active { cursor: grabbing; }

        /* ========================================
           ZONE: BOTTOM (History Stack)
           ======================================== */
        #zone-bottom {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 12px;
        }

        /* ========================================
           FOOTER (Checklist + Timer)
           ======================================== */
        footer {
            height: var(--footer-h);
            padding: 8px 16px;
            border-top: 2px solid var(--primary);
            background: white;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .footer-label { font-size: 11px; font-weight: 700; margin-bottom: 4px; color: #666; }
        .footer-row { display: flex; align-items: center; gap: 8px; flex: 1; }
        #checklist-area {
            flex: 1;
            border: 1px solid var(--primary);
            padding: 6px 10px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-content: flex-start;
        }
        #timer {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            padding: 8px 12px;
            border: 1px solid var(--primary);
            background: white;
        }

        /* ========================================
           CARD STYLES (Preview & History)
           ======================================== */
        .card {
            background: var(--card-bg);
            border: 2px solid var(--primary);
            border-radius: 8px;
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .preview-card {
            width: var(--preview-width);
            height: var(--preview-height);
        }

        .history-card {
            width: var(--history-width);
            height: var(--history-height);
            opacity: 0.5;
            filter: grayscale(80%);
        }

        /* Card Content */
        .card-header {
            font-size: 9px;
            text-transform: uppercase;
            color: #666;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .card-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 6px;
            padding: 0 10px;
        }
        .card-body {
            font-size: 12px;
            color: #444;
            padding: 0 10px;
            line-height: 1.4;
        }

        /* Cover styling */
        .cover-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .cover-subtitle { font-size: 12px; color: #666; }

        /* Debug info */
        #debug {
            position: absolute;
            bottom: 5px;
            left: 5px;
            font-size: 9px;
            color: #999;
            font-family: monospace;
        }
    </style>
</head>
<body>

<div id="app">
    <!-- Header -->
    <header>
        <div class="app-title">Resuscitation Handbook</div>
        <div class="header-icons">
            <svg class="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
            </svg>
            <svg class="header-icon" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/>
            </svg>
        </div>
    </header>

    <!-- Stage -->
    <div id="stage">
        <!-- Top Zone: Preview Stack -->
        <div id="zone-top"></div>

        <!-- Middle Zone: Wheel + Active Card -->
        <div id="zone-middle">
            <div id="wheel"></div>
            <div id="active-card"></div>
            <div id="knob"></div>
        </div>

        <!-- Bottom Zone: History Stack -->
        <div id="zone-bottom"></div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-label">Check List</div>
        <div class="footer-row">
            <div id="checklist-area"></div>
            <div id="timer">00:00:00</div>
        </div>
    </footer>

    <!-- Debug -->
    <div id="debug"></div>
</div>

<script>
// ========================================
// JSON DATA (Simplified for Step 1)
// ========================================
const ALGORITHM = {
    deck: [
        {
            id: "CARD_00_START",
            type: "cover",
            content: { title: "Paediatric Basic Life Support", subtitle: "Out-of-Hospital Algorithm" },
            wheel_config: { position_degrees: 330 },
            transitions: { type: "linear", next_id: "CARD_01_UNRESPONSIVE" }
        },
        {
            id: "CARD_01_UNRESPONSIVE",
            type: "standard",
            content: { title: "Assessment", body: "Is the child unresponsive?" },
            wheel_config: { position_degrees: 0 },
            transitions: { type: "linear", next_id: "CARD_02_SHOUT" }
        },
        {
            id: "CARD_02_SHOUT",
            type: "standard",
            content: { title: "Call for Help", body: "Shout loudly for help." },
            wheel_config: { position_degrees: 15 },
            transitions: { type: "linear", next_id: "CARD_03_AIRWAY" }
        },
        {
            id: "CARD_03_AIRWAY",
            type: "standard",
            content: { title: "Airway", body: "Open Airway\n(Head tilt, chin lift)" },
            wheel_config: { position_degrees: 30 },
            transitions: { type: "linear", next_id: "CARD_04_BREATHING" }
        },
        {
            id: "CARD_04_BREATHING",
            type: "decision",
            content: { title: "Breathing Check", body: "Is the child breathing normally?" },
            wheel_config: { position_degrees: 45 },
            transitions: {
                type: "split",
                options: [
                    { label: "YES", target_id: "CARD_END_OBSERVE" },
                    { label: "NO", target_id: "CARD_05_BREATHS" }
                ]
            }
        },
        {
            id: "CARD_END_OBSERVE",
            type: "terminal",
            content: { title: "Observation", body: "Observe and re-assess as necessary." },
            wheel_config: { position_degrees: 60 },
            status: "complete"
        },
        {
            id: "CARD_05_BREATHS",
            type: "standard",
            content: { title: "5 Rescue Breaths", body: "Give 5 initial rescue breaths." },
            wheel_config: { position_degrees: 90 },
            transitions: { type: "linear", next_id: "CARD_06_CPR" }
        },
        {
            id: "CARD_06_CPR",
            type: "loop_start",
            content: { title: "30 Chest Compressions", body: "Push hard and fast." },
            wheel_config: { position_degrees: 180, phase: "cpr_loop" },
            transitions: { type: "linear", next_id: "CARD_07_BREATHS" }
        },
        {
            id: "CARD_07_BREATHS",
            type: "standard",
            content: { title: "2 Rescue Breaths", body: "Deliver 2 effective breaths." },
            wheel_config: { position_degrees: 200 },
            transitions: { type: "linear", next_id: "CARD_08_CHECK" }
        },
        {
            id: "CARD_08_CHECK",
            type: "decision",
            content: { title: "Re-assess", body: "Are there clear signs of life?" },
            wheel_config: { position_degrees: 220 },
            transitions: {
                type: "split",
                options: [
                    { label: "NO", target_id: "CARD_06_CPR" },
                    { label: "YES", target_id: "CARD_END_RECOVERY" }
                ]
            }
        },
        {
            id: "CARD_END_RECOVERY",
            type: "terminal",
            content: { title: "Recovery", body: "Keep child safe, await EMS." },
            wheel_config: { position_degrees: 60 },
            status: "complete"
        }
    ]
};

// Build lookup
const DECK = {};
ALGORITHM.deck.forEach(card => DECK[card.id] = card);

// ========================================
// STATE (with FSM wheel)
// ========================================
let state = {
    currentId: "CARD_00_START",
    history: [],
    decisionIndex: 0,
    timerSeconds: 0,
    timerRunning: false,
    timerInterval: null,
    
    // FSM wheel state
    wheel: {
        mode: "COVER",      // COVER | LINEAR | DECISION | LOOP | TERMINAL
        angle: 330,         // Current angle for knob
        dragOrigin: null    // Angle at start of drag
    }
};

// ========================================
// DOM REFERENCES
// ========================================
const zoneTop = document.getElementById('zone-top');
const zoneMiddle = document.getElementById('zone-middle');
const zoneBottom = document.getElementById('zone-bottom');
const activeCard = document.getElementById('active-card');
const wheel = document.getElementById('wheel');
const knob = document.getElementById('knob');
const timerEl = document.getElementById('timer');
const debugEl = document.getElementById('debug');

// ========================================
// WHEEL PHYSICS
// ========================================
const WHEEL_RADIUS = 150; // Half of wheel diameter
const KNOB_OFFSET = 15;   // Half of knob size
const THRESHOLD_DEG = 25; // Degrees to trigger advance/rewind
const DECISION_STEP_DEG = 20; // Degrees to switch decision option

// Convert design degrees (0° = top, clockwise) to x,y position
function degToPosition(deg) {
    const mathDeg = deg - 90; // Convert to math coords (0° = right)
    const rad = mathDeg * (Math.PI / 180);
    return {
        x: WHEEL_RADIUS + WHEEL_RADIUS * Math.cos(rad) - KNOB_OFFSET,
        y: WHEEL_RADIUS + WHEEL_RADIUS * Math.sin(rad) - KNOB_OFFSET
    };
}

function setKnobPosition(deg) {
    const pos = degToPosition(deg);
    // Position relative to zone-middle
    const offsetX = (zoneMiddle.offsetWidth - 300) / 2;
    const offsetY = (zoneMiddle.offsetHeight - 300) / 2;
    knob.style.left = (offsetX + pos.x) + 'px';
    knob.style.top = (offsetY + pos.y) + 'px';
}

// ========================================
// WHEEL STATE HELPERS (FSM)
// ========================================
function computeWheelMode(card) {
    if (!card) return "LINEAR";
    if (card.type === "cover") return "COVER";
    if (card.type === "decision") return "DECISION";
    if (card.type === "terminal") return "TERMINAL";
    if (card.wheel_config && card.wheel_config.phase === "cpr_loop") return "LOOP";
    return "LINEAR";
}

function canonicalAngleForCard(card, fallback) {
    if (card && card.wheel_config && typeof card.wheel_config.position_degrees === "number") {
        return card.wheel_config.position_degrees;
    }
    return typeof fallback === "number" ? fallback : 330;
}

// Wrap-safe delta (positive = anticlockwise drag)
function angleDelta(fromDeg, toDeg) {
    let delta = fromDeg - toDeg;
    if (delta > 180) delta -= 360;
    if (delta < -180) delta += 360;
    return delta;
}

// ========================================
// RENDER
// ========================================
function render() {
    const card = DECK[state.currentId];
    if (!card) return;
    
    // 1. Derive wheel mode
    state.wheel.mode = computeWheelMode(card);
    
    // 2. Snap angle if not dragging
    if (!isDraggingKnob) {
        state.wheel.angle = canonicalAngleForCard(card, state.wheel.angle);
    }
    
    // 3. Position knob
    setKnobPosition(state.wheel.angle);
    
    // 4. Render card content
    renderActiveCard(card);
    
    // 5. Render preview stack
    renderPreviewZone(card);
    
    // 6. Render history stack
    renderHistoryZone();
    
    // 7. Update debug
    updateDebug();
}

function renderActiveCard(card) {
    // Reset classes
    activeCard.className = '';
    
    if (card.type === 'cover') {
        activeCard.classList.add('cover-mode');
        activeCard.innerHTML = `
            <div class="cover-title">${card.content.title}</div>
            <div class="cover-subtitle">${card.content.subtitle || ''}</div>
        `;
    } else {
        if (card.wheel_config?.phase === 'cpr_loop' || card.type === 'loop_start') {
            activeCard.classList.add('loop-mode');
        }
        activeCard.innerHTML = `
            <div class="card-header">${card.content.title}</div>
            <div class="card-body">${card.content.body.replace(/\n/g, '<br>')}</div>
        `;
    }
}

function renderPreviewZone(card) {
    zoneTop.innerHTML = '';
    
    // For Step 1: Just show linear preview (no decision carousel yet)
    const upcoming = getUpcomingCards(card, 3);
    
    upcoming.reverse().forEach((c, i) => {
        const depth = upcoming.length - 1 - i;
        const el = document.createElement('div');
        el.className = 'card preview-card';
        el.style.transform = `translateY(${depth * -8}px) scale(${1 - depth * 0.05})`;
        el.style.zIndex = 10 - depth;
        el.innerHTML = `<div class="card-header">${c.content.title}</div>`;
        zoneTop.appendChild(el);
    });
}

function getUpcomingCards(card, max) {
    const result = [];
    let nextId = card.transitions?.next_id;
    
    // For splits, preview first option path
    if (card.transitions?.type === 'split' && card.transitions.options) {
        nextId = card.transitions.options[0].target_id;
    }
    
    while (nextId && result.length < max && DECK[nextId]) {
        const nextCard = DECK[nextId];
        result.push(nextCard);
        
        if (nextCard.transitions?.next_id) {
            nextId = nextCard.transitions.next_id;
        } else if (nextCard.transitions?.options) {
            nextId = nextCard.transitions.options[0].target_id;
        } else {
            break;
        }
    }
    return result;
}

function renderHistoryZone() {
    zoneBottom.innerHTML = '';
    
    const recent = state.history.slice(-3);
    recent.forEach((id, i, arr) => {
        const c = DECK[id];
        if (!c) return;
        
        const depth = arr.length - 1 - i;
        const el = document.createElement('div');
        el.className = 'card history-card';
        el.style.transform = `translateY(${depth * 6}px) scale(${1 - depth * 0.05})`;
        el.style.zIndex = 10 - depth;
        el.innerHTML = `<div class="card-header">${c.content.title}</div>`;
        zoneBottom.appendChild(el);
    });
}

function updateDebug() {
    const card = DECK[state.currentId];
    debugEl.textContent = `Mode: ${state.wheel.mode} | Card: ${state.currentId} | Angle: ${Math.round(state.wheel.angle)}°`;
}

// ========================================
// NAVIGATION
// ========================================
function advance() {
    const card = DECK[state.currentId];
    if (!card || card.status === 'complete') return;
    
    let nextId = null;
    
    if (card.transitions?.type === 'linear') {
        nextId = card.transitions.next_id;
    } else if (card.transitions?.type === 'split') {
        // For Step 1: Just use first option (decision carousel comes in Step 2)
        nextId = card.transitions.options[state.decisionIndex].target_id;
        state.decisionIndex = 0;
    }
    
    if (nextId && DECK[nextId]) {
        state.history.push(state.currentId);
        state.currentId = nextId;
        
        // Start timer on first advance from cover
        if (!state.timerRunning) startTimer();
        
        render();
    }
}

function rewind() {
    if (state.history.length > 0) {
        state.currentId = state.history.pop();
        state.decisionIndex = 0;
        render();
    }
}

// ========================================
// TIMER
// ========================================
function startTimer() {
    state.timerRunning = true;
    state.timerInterval = setInterval(() => {
        state.timerSeconds++;
        const h = Math.floor(state.timerSeconds / 3600);
        const m = Math.floor((state.timerSeconds % 3600) / 60);
        const s = state.timerSeconds % 60;
        timerEl.textContent = 
            String(h).padStart(2, '0') + ':' +
            String(m).padStart(2, '0') + ':' +
            String(s).padStart(2, '0');
    }, 1000);
}

// ========================================
// DRAG HANDLING (FSM-Driven)
// ========================================
let isDraggingKnob = false;

knob.addEventListener('mousedown', startKnobDrag);
knob.addEventListener('touchstart', startKnobDrag, { passive: false });
document.addEventListener('mousemove', onKnobDrag);
document.addEventListener('touchmove', onKnobDrag, { passive: false });
document.addEventListener('mouseup', endKnobDrag);
document.addEventListener('touchend', endKnobDrag);

function getAngleFromEvent(e) {
    const touch = e.touches ? e.touches[0] : e;
    const rect = wheel.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;
    
    let deg = Math.atan2(touch.clientY - cy, touch.clientX - cx) * 180 / Math.PI + 90;
    if (deg < 0) deg += 360;
    return deg;
}

function startKnobDrag(e) {
    isDraggingKnob = true;
    e.preventDefault();
    e.stopPropagation();
    
    const startAngle = getAngleFromEvent(e);
    state.wheel.dragOrigin = startAngle;
    state.wheel.angle = startAngle;
}

function onKnobDrag(e) {
    if (!isDraggingKnob) return;
    e.preventDefault();
    
    const card = DECK[state.currentId];
    if (!card) return;
    
    const currentAngle = getAngleFromEvent(e);
    
    if (state.wheel.dragOrigin === null) {
        state.wheel.dragOrigin = currentAngle;
    }
    
    const delta = angleDelta(state.wheel.dragOrigin, currentAngle);
    const mode = state.wheel.mode;
    
    // --- COVER: Visual only, but allow advance on threshold ---
    if (mode === "COVER") {
        state.wheel.angle = currentAngle;
        setKnobPosition(state.wheel.angle);
        
        // Allow advancing out of cover
        if (delta > THRESHOLD_DEG) {
            advance();
            state.wheel.dragOrigin = currentAngle;
            if (navigator.vibrate) navigator.vibrate(15);
        }
        return;
    }
    
    // --- TERMINAL: Visual only, no navigation ---
    if (mode === "TERMINAL") {
        state.wheel.angle = currentAngle;
        setKnobPosition(state.wheel.angle);
        return;
    }
    
    // --- DECISION: For Step 1, treat like LINEAR (Step 2 will add carousel) ---
    // --- LINEAR / LOOP: Standard navigation ---
    if (delta > THRESHOLD_DEG) {
        // Anticlockwise = ADVANCE
        advance();
        state.wheel.dragOrigin = currentAngle;
        if (navigator.vibrate) navigator.vibrate(15);
        return;
    }
    
    if (delta < -THRESHOLD_DEG) {
        // Clockwise = REWIND
        rewind();
        state.wheel.dragOrigin = currentAngle;
        if (navigator.vibrate) navigator.vibrate(15);
        return;
    }
    
    // Below threshold: just move knob visually
    state.wheel.angle = currentAngle;
    setKnobPosition(state.wheel.angle);
}

function endKnobDrag() {
    if (!isDraggingKnob) return;
    isDraggingKnob = false;
    
    state.wheel.dragOrigin = null;
    
    // Snap to canonical angle
    const card = DECK[state.currentId];
    if (card) {
        state.wheel.angle = canonicalAngleForCard(card, state.wheel.angle);
        setKnobPosition(state.wheel.angle);
    }
}

// ========================================
// INIT
// ========================================
render();
console.log('Step 1 initialized. Mode:', state.wheel.mode);
</script>
</body>
</html>
