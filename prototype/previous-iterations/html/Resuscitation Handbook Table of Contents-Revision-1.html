<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resus App - Mid Term Redo</title>
    <style>
        /* --- 1. PARAMETRIC ENGINE (Global Variables) --- */
        :root {
            /* GEOMETRY & LAYOUT */
            --app-max-width: 420px;
            --header-h: 60px;
            --footer-h: 120px;
            --wheel-diameter: 350px;
            --card-width: 260px; /* ~75% of wheel */
            --card-height: 340px;
            --card-radius: 16px;
            --stroke-width: 2px;
            
            /* COLORS (Line Art Style) */
            --primary: #1a1a1a;
            --bg-color: #fafafa;
            --card-bg: #ffffff;
            --rail-color: #e5e5e5;
            --accent-red: #d32f2f;
            --text-muted: #888888;

            /* EXPOSURE ENGINE (Dev adjustable) */
            --global-contrast: 100%;
            --global-sepia: 0%;
            --global-brightness: 100%;
        }

        /* --- 2. GLOBAL RESET & UTILS --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #111;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            /* Parametric Filter Application */
            filter: contrast(var(--global-contrast)) sepia(var(--global-sepia)) brightness(var(--global-brightness));
        }

        #app-frame {
            width: 100%;
            max-width: var(--app-max-width);
            height: 100%;
            background-color: var(--bg-color);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- 3. SECTIONS --- */
        
        /* HEADER */
        header {
            height: var(--header-h);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            z-index: 500;
        }
        .app-title { font-weight: 700; font-size: 16px; letter-spacing: -0.5px; color: var(--primary); }
        .icon-btn { width: 24px; height: 24px; color: var(--primary); cursor: pointer; }

        /* STAGE (The Playable Area) */
        #stage {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* ZONES */
        .zone { position: relative; width: 100%; display: flex; justify-content: center; }
        
        #zone-top { 
            flex: 1; /* Variable height based on screen */
            align-items: flex-end; /* Stack sits at bottom of zone */
            padding-bottom: 20px;
            perspective: 800px;
            z-index: 50; 
        }

        #zone-middle { 
            height: var(--wheel-diameter); /* Fixed height for symmetry */
            align-items: center;
            z-index: 100;
        }

        #zone-bottom { 
            flex: 1; 
            align-items: flex-start;
            padding-top: 20px;
            z-index: 40; 
        }

        /* FOOTER */
        footer {
            height: var(--footer-h);
            background: var(--card-bg);
            border-top: 1px solid rgba(0,0,0,0.05);
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            z-index: 500;
        }

        /* --- 4. WHEEL & RAIL --- */
        #wheel-layer {
            position: absolute;
            width: var(--wheel-diameter);
            height: var(--wheel-diameter);
            border-radius: 50%;
            border: 1px solid var(--rail-color);
            /* Centering Logic */
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 90;
            pointer-events: none;
        }

        #knob {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 50%;
            position: absolute;
            /* Initial Position: 11:00 (330deg) */
            top: 14%; left: 25%; 
            transform: translate(-50%, -50%);
            cursor: grab;
            pointer-events: auto;
            z-index: 200;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* --- 5. CARDS --- */
        .card {
            background: var(--card-bg);
            border: var(--stroke-width) solid var(--primary);
            border-radius: var(--card-radius);
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s, box-shadow 0.3s;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        /* Card Sizes */
        .card-active {
            width: var(--card-width);
            height: var(--card-height);
            z-index: 110;
        }

        .card-preview {
            width: 220px;
            height: 140px;
            cursor: pointer; /* Swipable */
        }
        
        .card-history {
            width: 200px;
            height: 120px;
            opacity: 0.4;
            filter: grayscale(1);
        }

        /* Special States */
        .card.cover-mode {
            border: none;
            box-shadow: none;
            background: transparent;
        }
        .card.cover-mode .card-header { font-size: 24px; color: var(--primary); }
        .card.cover-mode .card-body { display: none; }

        /* Decision Carousel Logic */
        .decision-option {
            transition: transform 0.3s, opacity 0.3s;
            border-color: var(--text-muted);
        }
        .decision-option.selected {
            border-color: var(--primary);
            transform: scale(1.1);
            z-index: 60;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .decision-option.flank {
            opacity: 0.5;
            z-index: 40;
        }

        /* Typography */
        .card-header { font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; }
        .card-body { font-size: 20px; font-weight: 600; color: var(--primary); padding: 0 15px; line-height: 1.4; }

        /* Icons */
        .icon-overlay { position: absolute; width: 24px; height: 24px; opacity: 0.8; }
        .icon-tl { top: 12px; left: 12px; } /* Decision Tree Upper */
        .icon-tr { top: 12px; right: 12px; } /* Fullscreen */
        .icon-bl { bottom: 12px; left: 12px; } /* Toolbox */
        .icon-br { bottom: 12px; right: 12px; } /* Decision Lower */

        /* FOOTER ELEMENTS */
        .checklist-container { flex: 1; overflow-y: auto; }
        .checklist-item { 
            display: flex; align-items: center; 
            padding: 8px 0; border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .checklist-item input { margin-right: 12px; width: 18px; height: 18px; accent-color: var(--primary); }
        .timer { 
            font-family: 'Courier New', monospace; font-size: 14px; font-weight: 700; 
            text-align: right; padding-top: 10px; 
        }

        /* HIDDEN SETTINGS */
        #dev-settings {
            position: absolute; top: 70px; left: 20px; right: 20px;
            background: white; border: 2px solid black; padding: 20px;
            display: none; z-index: 999; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        #dev-settings label { display: block; margin-bottom: 10px; font-weight: bold; }

    </style>
</head>
<body>

<div id="app-frame">
    <header>
        <div class="app-title" id="header-title">Resuscitation Handbook</div>
        <div class="icon-btn">
            <!-- Search Icon -->
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </div>
    </header>

    <div id="dev-settings">
        <h3>Parametric Engine</h3>
        <label>Contrast <input type="range" min="50" max="150" value="100" oninput="setVar('--global-contrast', this.value + '%')"></label>
        <label>Sepia <input type="range" min="0" max="100" value="0" oninput="setVar('--global-sepia', this.value + '%')"></label>
        <label>Brightness <input type="range" min="50" max="150" value="100" oninput="setVar('--global-brightness', this.value + '%')"></label>
        <button onclick="document.getElementById('dev-settings').style.display='none'">Close</button>
    </div>

    <div id="stage">
        <!-- ZONES -->
        <div id="zone-top" class="zone"></div>
        
        <div id="zone-middle" class="zone">
            <!-- RAIL & KNOB -->
            <div id="wheel-layer">
                <div id="knob"></div>
            </div>
            <!-- ACTIVE CARD SLOT -->
            <div id="active-slot" style="position: absolute; display: flex; justify-content: center; align-items: center; width:100%; height:100%;"></div>
        </div>

        <div id="zone-bottom" class="zone"></div>
    </div>

    <footer>
        <div class="checklist-container" id="checklist-ui"></div>
        <div class="timer" id="global-timer">00:00:00</div>
    </footer>
</div>

<!-- INLINE SVG SPRITES (Using described logic/names) -->
<svg style="display: none;">
    <symbol id="icon-toolbox" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 7h18v14H3z" /><path d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2M12 11v6M9 14h6" />
    </symbol>
    <symbol id="icon-fullscreen" viewBox="0 0 24 24" fill="currentColor">
        <path d="M3 3h6v2H5v4H3V3zm18 0h-6v2h4v4h2V3zm-6 18h6v-6h-2v4h-4v2zM3 21h6v-2H5v-4H3v6z"/>
    </symbol>
    <symbol id="icon-decision-upper" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2v6m0 0L6 14m6-6l6 6" /><rect x="4" y="14" width="4" height="4"/><rect x="16" y="14" width="4" height="4"/>
    </symbol>
    <symbol id="icon-decision-lower" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2v6m0 0L6 14" /><rect x="4" y="14" width="4" height="4" fill="black"/>
    </symbol>
</svg>

<script>
/**
 * --- RESUS APP REDO: FULL LOGIC ---
 */

// 1. DATA SCHEMA (State Machine)
const DECK = {
    "START": { 
        id: "START", type: "cover", title: "Paediatric Basic Life Support", body: "Pull Wheel to Start", next: "C01" 
    },
    "C01": { 
        id: "C01", type: "standard", title: "Assessment", body: "Is the child unresponsive?", checklist: ["Check Danger", "Check Response"], next: "C02" 
    },
    "C02": { 
        id: "C02", type: "standard", title: "Call for Help", body: "Shout loudly for help", checklist: ["2nd Rescuer?", "Call 999", "Get AED"], next: "C03" 
    },
    "C03": { 
        id: "C03", type: "standard", title: "Airway", body: "Open Airway\n(Head tilt, chin lift)", checklist: ["Mouth Clear?"], next: "C04" 
    },
    "C04": { 
        id: "C04", type: "decision", title: "Breathing Check", body: "Is the child breathing normally?", 
        options: [
            { label: "NO", next: "C05_NO" },
            { label: "YES", next: "C05_YES" }
        ]
    },
    "C05_NO": { id: "C05_NO", type: "standard", title: "5 Rescue Breaths", body: "Give 5 breaths immediately", next: "C06" },
    "C05_YES": { id: "C05_YES", type: "terminal", title: "Observation", body: "Recovery Position", next: null }
};

// 2. STATE
let state = {
    currentId: "START",
    history: [],
    wheelAngle: 330, // 11:00 position
    decisionIndex: 0, // 0=Left(No), 1=Right(Yes) for 2 options
    timerStarted: false,
    startTime: 0
};

// 3. CONSTANTS
const WHEEL_RADIUS = 175; // Half of 350px var
const DECISION_LOCK_ANGLE = 270; // 9 o'clock

// 4. DOM ELEMENTS
const knob = document.getElementById('knob');
const stage = document.getElementById('stage');
const activeSlot = document.getElementById('active-slot');
const topZone = document.getElementById('zone-top');
const bottomZone = document.getElementById('zone-bottom');
const checklistUI = document.getElementById('checklist-ui');

// 5. RENDER ENGINE
function render() {
    const card = DECK[state.currentId];
    
    // --- Middle Card ---
    let tools = card.type === 'standard' ? `
        <svg class="icon-overlay icon-bl"><use href="#icon-toolbox"></use></svg>
        <svg class="icon-overlay icon-tr"><use href="#icon-fullscreen"></use></svg>
    ` : '';
    
    let cardClass = card.type === 'cover' ? 'cover-mode' : 'card-active';
    
    activeSlot.innerHTML = `
        <div class="card ${cardClass}">
            <div class="card-header">${card.title}</div>
            <div class="card-body" style="white-space: pre-line">${card.body}</div>
            ${tools}
        </div>
    `;

    // --- Top Zone (Preview / Miracle Carousel) ---
    topZone.innerHTML = '';
    
    // IF CURRENT IS DECISION: Render Horizontal Carousel
    if (card.type === 'decision') {
        renderMiracleCarousel(card);
    } 
    // ELSE: Render Standard Vertical Stack
    else if (card.next) {
        // Look ahead logic
        let nextIds = [];
        let curr = card.next;
        for(let i=0; i<3; i++){
            if(curr && DECK[curr]) {
                nextIds.push(DECK[curr]);
                // Simple prediction for stack (assume opt 0 if decision)
                curr = DECK[curr].next || (DECK[curr].options ? DECK[curr].options[0].next : null);
            }
        }
        
        nextIds.reverse().forEach((c, idx) => {
            let offset = (nextIds.length - 1 - idx) * 12;
            let scale = 0.9 - ((nextIds.length - 1 - idx) * 0.05);
            let icon = c.type === 'decision' ? `<svg class="icon-overlay icon-tl"><use href="#icon-decision-upper"></use></svg>` : '';
            
            let el = document.createElement('div');
            el.className = 'card card-preview';
            el.innerHTML = `<div class="card-header">${c.title}</div>${icon}`;
            el.style.zIndex = idx;
            el.style.transform = `translateY(-${offset}px) scale(${scale})`;
            el.style.marginBottom = `-${130 - offset}px`; // Collapse stack
            
            // Interaction: Swipe Down to Pull
            if (idx === nextIds.length - 1) { // Front card
                el.addEventListener('touchstart', handleSwipeStart, {passive: false});
                el.addEventListener('touchend', (e) => handleSwipeEnd(e, false), {passive: false});
            }
            topZone.appendChild(el);
        });
    }

    // --- Bottom Zone (History) ---
    bottomZone.innerHTML = '';
    if (state.history.length > 0) {
        let lastId = state.history[state.history.length - 1];
        let c = DECK[lastId];
        let icon = c.type === 'decision' ? `<svg class="icon-overlay icon-br"><use href="#icon-decision-lower"></use></svg>` : '';
        
        let el = document.createElement('div');
        el.className = 'card card-history';
        el.innerHTML = `<div class="card-header">${c.title}</div>${icon}`;
        el.style.marginTop = '-80px';
        bottomZone.appendChild(el);
    }

    // --- Checklist ---
    checklistUI.innerHTML = '';
    if (card.checklist) {
        card.checklist.forEach(txt => {
            checklistUI.innerHTML += `<div class="checklist-item"><input type="checkbox">${txt}</div>`;
        });
    }
}

function renderMiracleCarousel(card) {
    // Miracle Logic: Wheel Rotation controls this
    card.options.forEach((opt, idx) => {
        let isSelected = idx === state.decisionIndex;
        let xOffset = (idx - state.decisionIndex) * 140; // Spacing
        let scale = isSelected ? 1.0 : 0.8;
        let opacity = isSelected ? 1.0 : 0.4;
        
        let el = document.createElement('div');
        el.className = `card card-preview decision-option ${isSelected ? 'selected' : 'flank'}`;
        el.innerHTML = `<div class="card-header">OPTION</div><div class="card-body">${opt.label}</div>`;
        el.style.position = 'absolute';
        el.style.bottom = '10px';
        el.style.transform = `translateX(${xOffset}px) scale(${scale})`;
        el.style.opacity = opacity;
        
        // Interaction: Swipe Selected Down
        if (isSelected) {
            el.addEventListener('touchstart', handleSwipeStart, {passive: false});
            el.addEventListener('touchend', (e) => handleSwipeEnd(e, true, opt.next), {passive: false});
        }
        
        topZone.appendChild(el);
    });
}

// 6. PHYSICS & INTERACTION
let isDragging = false;
let startY = 0;

// Knob Events
knob.addEventListener('touchstart', (e) => { isDragging = true; e.preventDefault(); }, {passive: false});
document.addEventListener('touchmove', handleKnobMove, {passive: false});
document.addEventListener('touchend', () => { isDragging = false; snapKnob(); });

// Mouse fallbacks
knob.addEventListener('mousedown', (e) => { isDragging = true; e.preventDefault(); });
document.addEventListener('mousemove', handleKnobMove);
document.addEventListener('mouseup', () => { isDragging = false; snapKnob(); });

function handleKnobMove(e) {
    if (!isDragging) return;
    
    let clientX = e.touches ? e.touches[0].clientX : e.clientX;
    let clientY = e.touches ? e.touches[0].clientY : e.clientY;
    
    // Get Wheel Center (Dynamic)
    let rect = document.getElementById('wheel-layer').getBoundingClientRect();
    let cx = rect.left + rect.width/2;
    let cy = rect.top + rect.height/2;
    
    // Calculate Angle (0-360, 0 is 3 o'clock)
    let rad = Math.atan2(clientY - cy, clientX - cx);
    let deg = rad * (180/Math.PI);
    if (deg < 0) deg += 360;
    
    // LOGIC: Detect Anticlockwise Pull
    // Previous angle: state.wheelAngle
    // If moving 330 -> 270, delta is positive (pulling down)
    // We normalize rotation to be contiguous
    
    let currentType = DECK[state.currentId].type;
    
    // -- DECISION MODE (MIRACLE) --
    if (currentType === 'decision') {
        // Lock knob to 9 o'clock visually (resistance)
        // But map horizontal delta to index
        // Simple implementation: Map angle sectors to index
        // 240-300 = Index 0, 300-360 = Index 1
        
        if (deg > 220 && deg < 320) {
            // Visual feedback only allowed in small arc
            updateKnobPos(deg);
            
            // Map logic
            if (deg < 270) {
                if(state.decisionIndex !== 0) { state.decisionIndex = 0; render(); navigator.vibrate?.(10); }
            } else {
                if(state.decisionIndex !== 1) { state.decisionIndex = 1; render(); navigator.vibrate?.(10); }
            }
        }
    } 
    // -- STANDARD MODE --
    else {
        // Only allow movement if pulling anticlockwise from Start(330) or Hold(270)
        updateKnobPos(deg);
        
        // Trigger Point: Crossing 270 (9 o'clock)
        if (state.wheelAngle > 280 && deg < 270) {
            triggerNext();
        }
    }
    
    state.wheelAngle = deg;
}

function updateKnobPos(deg) {
    // Visual update
    let rad = deg * (Math.PI/180);
    let x = 50 + 50 * Math.cos(rad);
    let y = 50 + 50 * Math.sin(rad);
    knob.style.left = x + '%';
    knob.style.top = y + '%';
}

function snapKnob() {
    // Return to resting positions based on state
    let target = DECK[state.currentId].type === 'cover' ? 330 : 270;
    updateKnobPos(target);
    state.wheelAngle = target;
}

// 7. TRANSITION LOGIC
function triggerNext(forcedNextId = null) {
    let curr = DECK[state.currentId];
    let nextId = forcedNextId || curr.next;
    
    if (nextId) {
        state.history.push(state.currentId);
        state.currentId = nextId;
        
        // Start Timer
        if (!state.timerStarted) {
            state.timerStarted = true;
            state.startTime = Date.now();
            setInterval(() => {
                let diff = Math.floor((Date.now() - state.startTime)/1000);
                let h = Math.floor(diff/3600).toString().padStart(2,'0');
                let m = Math.floor((diff%3600)/60).toString().padStart(2,'0');
                let s = (diff%60).toString().padStart(2,'0');
                document.getElementById('global-timer').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }
        
        render();
        snapKnob();
    }
}

// 8. SWIPE HANDLERS (Top Card)
function handleSwipeStart(e) { startY = e.touches[0].clientY; }
function handleSwipeEnd(e, isDecision, nextId) {
    let deltaY = e.changedTouches[0].clientY - startY;
    if (deltaY > 50) { // Swiped Down
        if (isDecision) {
            triggerNext(nextId);
        } else {
            triggerNext();
        }
    }
}

// 9. DEV SETTINGS
let titlePressTimer;
document.getElementById('header-title').addEventListener('touchstart', () => {
    titlePressTimer = setTimeout(() => {
        document.getElementById('dev-settings').style.display = 'block';
    }, 2000); // 2s long press
});
document.getElementById('header-title').addEventListener('touchend', () => clearTimeout(titlePressTimer));

function setVar(name, val) { document.documentElement.style.setProperty(name, val); }

// INIT
render();
updateKnobPos(330);

</script>
</body>
</html>