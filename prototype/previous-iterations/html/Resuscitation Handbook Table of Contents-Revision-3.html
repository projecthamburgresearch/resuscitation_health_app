<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resus App - Final Mid-Term</title>
    <style>
        /* ------------------------------------------------------------------
           1. PARAMETRIC ENGINE (Global Variables)
           ------------------------------------------------------------------ */
        :root {
            /* GEOMETRY & LAYOUT */
            --app-max-width: 420px;
            --header-h: 60px;
            --footer-h: 140px; /* Taller to accommodate checklist + timer row */
            --wheel-diameter: 350px;
            --card-width: 260px; /* ~75% of wheel */
            --card-height: 340px;
            --card-radius: 16px;
            --stroke-width: 2px;
            
            /* COLORS (Line Art Style) */
            --primary: #1a1a1a;
            --bg-color: #fafafa;
            --card-bg: #ffffff;
            --rail-color: #e0e0e0;
            --accent-red: #d32f2f;
            --text-muted: #888888;

            /* EXPOSURE ENGINE */
            --global-contrast: 100%;
            --global-sepia: 0%;
            --global-brightness: 100%;
        }

        /* ------------------------------------------------------------------
           2. GLOBAL RESET & BASE
           ------------------------------------------------------------------ */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #111;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            /* Parametric Filter Application */
            filter: contrast(var(--global-contrast)) sepia(var(--global-sepia)) brightness(var(--global-brightness));
        }

        #app-frame {
            width: 100%;
            max-width: var(--app-max-width);
            height: 100%;
            max-height: 900px; /* Reasonable limit for desktop view */
            background-color: var(--bg-color);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* ------------------------------------------------------------------
           3. HEADER
           ------------------------------------------------------------------ */
        header {
            height: var(--header-h);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            z-index: 500;
        }

        .app-title { font-weight: 700; font-size: 16px; letter-spacing: -0.3px; color: var(--primary); }
        .icon-btn { width: 24px; height: 24px; color: var(--primary); cursor: pointer; }

        /* ------------------------------------------------------------------
           4. STAGE (Playable Area)
           ------------------------------------------------------------------ */
        #stage {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .zone { position: relative; width: 100%; display: flex; justify-content: center; }
        
        #zone-top { 
            flex: 1;
            align-items: flex-end; /* Stack sits at bottom of zone */
            padding-bottom: 10px;
            perspective: 800px;
            z-index: 50;
        }

        #zone-middle { 
            height: var(--wheel-diameter);
            align-items: center;
            z-index: 100;
        }

        #zone-bottom { 
            flex: 1;
            align-items: flex-start; /* History sits at top */
            padding-top: 10px;
            z-index: 40;
        }

        /* ------------------------------------------------------------------
           5. WHEEL & KNOB (Corrected Math)
           ------------------------------------------------------------------ */
        #wheel-layer {
            position: absolute;
            width: var(--wheel-diameter);
            height: var(--wheel-diameter);
            border-radius: 50%;
            border: 1px solid var(--rail-color);
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 90;
            pointer-events: none;
        }

        #knob {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border-radius: 50%;
            position: absolute;
            cursor: grab;
            pointer-events: auto;
            z-index: 200;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            /* Transformation handled by JS to allow -90deg offset logic */
        }
        #knob:active { cursor: grabbing; transform: scale(0.95); }

        /* ------------------------------------------------------------------
           6. CARDS
           ------------------------------------------------------------------ */
        .card {
            background: var(--card-bg);
            border: var(--stroke-width) solid var(--primary);
            border-radius: var(--card-radius);
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s, box-shadow 0.3s;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        }

        .card-active { width: var(--card-width); height: var(--card-height); z-index: 110; }
        .card-preview { width: 220px; height: 140px; cursor: pointer; }
        .card-history { width: 200px; height: 120px; opacity: 0.4; filter: grayscale(1); }

        /* Cover Mode (Transparent Title) */
        .card.cover-mode {
            border: none;
            box-shadow: none;
            background: transparent;
            width: 100%;
            height: auto;
        }
        .card.cover-mode .card-header { font-size: 22px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        .card.cover-mode .card-body { display: none; }

        /* Decision Options (Miracle Carousel) */
        .decision-option { transition: transform 0.3s, opacity 0.3s; border-color: var(--text-muted); }
        .decision-option.selected { border-color: var(--primary); transform: scale(1.1); z-index: 60; box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        .decision-option.flank { opacity: 0.5; z-index: 40; }

        /* Content Styling */
        .card-header { font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; }
        .card-body { font-size: 20px; font-weight: 600; color: var(--primary); padding: 0 15px; line-height: 1.4; }

        /* Icons */
        .icon-overlay { position: absolute; width: 24px; height: 24px; opacity: 0.6; cursor: pointer; }
        .icon-overlay:hover { opacity: 1; }
        .icon-tl { top: 12px; left: 12px; }
        .icon-tr { top: 12px; right: 12px; }
        .icon-bl { bottom: 12px; left: 12px; }
        .icon-br { bottom: 12px; right: 12px; }

        /* ------------------------------------------------------------------
           7. FOOTER (Corrected Layout)
           ------------------------------------------------------------------ */
        footer {
            height: var(--footer-h);
            background: var(--card-bg);
            border-top: 1px solid rgba(0,0,0,0.08);
            padding: 12px 20px;
            display: flex;
            flex-direction: column;
            z-index: 500;
        }

        .checklist-container { flex: 1; overflow-y: auto; }
        .checklist-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 15px; }
        .checklist-item input { margin-right: 12px; width: 20px; height: 20px; accent-color: var(--primary); flex-shrink: 0; }

        /* Bottom Row: 3-Dot Menu + Timer */
        .footer-bottom {
            display: flex; align-items: center; justify-content: flex-end;
            padding-top: 10px; border-top: 1px solid #f0f0f0; margin-top: 8px; gap: 15px;
        }
        .overflow-menu { font-size: 20px; font-weight: bold; color: var(--text-muted); cursor: pointer; padding: 0 8px; letter-spacing: 2px; }
        #global-timer {
            font-family: 'SF Mono', 'Courier New', monospace; font-size: 14px; font-weight: 600; color: var(--primary);
            cursor: pointer; padding: 4px 10px; border: 1px solid var(--primary); border-radius: 4px;
        }

        /* ------------------------------------------------------------------
           8. DEV PANEL
           ------------------------------------------------------------------ */
        #dev-settings {
            position: absolute; top: 70px; left: 20px; right: 20px;
            background: white; border: 2px solid black; padding: 20px;
            display: none; z-index: 999; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        #dev-settings label { display: block; margin-bottom: 10px; font-weight: bold; }

    </style>
</head>
<body>

<div id="app-frame">
    <!-- HEADER -->
    <header>
        <div class="app-title" id="header-title">Resuscitation Handbook</div>
        <svg class="icon-btn" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
    </header>

    <!-- DEV PANEL -->
    <div id="dev-settings">
        <h3>Parametric Engine (Dev Only)</h3>
        <label>Contrast <input type="range" min="50" max="150" value="100" oninput="setVar('--global-contrast', this.value + '%')"></label>
        <label>Sepia <input type="range" min="0" max="100" value="0" oninput="setVar('--global-sepia', this.value + '%')"></label>
        <label>Brightness <input type="range" min="50" max="150" value="100" oninput="setVar('--global-brightness', this.value + '%')"></label>
        <button onclick="document.getElementById('dev-settings').style.display='none'">Close</button>
    </div>

    <!-- STAGE -->
    <div id="stage">
        <div id="zone-top" class="zone"></div>
        <div id="zone-middle" class="zone">
            <!-- Wheel Rail -->
            <div id="wheel-layer">
                <div id="knob"></div>
            </div>
            <!-- Active Card Slot -->
            <div id="active-slot" style="position:absolute;display:flex;justify-content:center;align-items:center;width:100%;height:100%;pointer-events:none;"></div>
        </div>
        <div id="zone-bottom" class="zone"></div>
    </div>

    <!-- FOOTER -->
    <footer>
        <div class="checklist-container" id="checklist-ui"></div>
        <div class="footer-bottom">
            <div class="overflow-menu">â‹®</div>
            <div id="global-timer">00:00:00</div>
        </div>
    </footer>
</div>

<!-- SVG SPRITES -->
<svg style="display: none;">
    <symbol id="icon-toolbox" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="7" width="18" height="14" rx="2"/><path d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"/><path d="M12 11v6M9 14h6"/>
    </symbol>
    <symbol id="icon-fullscreen" viewBox="0 0 24 24" fill="currentColor">
        <path d="M3 3h6v2H5v4H3V3zm18 0h-6v2h4v4h2V3zm-6 18h6v-6h-2v4h-4v2zM3 21h6v-2H5v-4H3v6z"/>
    </symbol>
    <symbol id="icon-decision-upper" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2v6m0 0L6 14m6-6l6 6"/><rect x="4" y="14" width="4" height="4"/><rect x="16" y="14" width="4" height="4"/>
    </symbol>
</svg>

<script>
/**
 * --- FINAL MID-TERM: CORRECTED MATH & LAYOUT ---
 */

// 1. DATA MODEL
const DECK = {
    START: { id: "START", type: "cover", title: "Paediatric Basic Life Support", body: "", next: "C01", checklist: [] },
    C01: { id: "C01", type: "standard", title: "Assessment", body: "Is the child unresponsive?", checklist: ["Check danger", "Check response"], next: "C02" },
    C02: { id: "C02", type: "standard", title: "Call for Help", body: "Shout loudly for help", checklist: ["Second rescuer available?", "Call 999", "Fetch AED"], next: "C03" },
    C03: { id: "C03", type: "standard", title: "Airway", body: "Open airway\n(Head tilt, chin lift)", checklist: ["Mouth clear?", "Head position?"], next: "C04" },
    C04: { id: "C04", type: "decision", title: "Breathing Check", body: "Is the child breathing normally?", options: [{ label: "NO", next: "C05_NO" }, { label: "YES", next: "C05_YES" }], checklist: ["Look, listen, feel"] },
    C05_NO: { id: "C05_NO", type: "standard", title: "5 Rescue Breaths", body: "Give 5 rescue breaths immediately.", checklist: ["Seal mask", "Chest rise"], next: "C06" },
    C05_YES: { id: "C05_YES", type: "terminal", title: "Observation", body: "Recovery position.\nMonitor.", checklist: ["Recovery position"], next: null }
};

// 2. STATE
let state = {
    currentId: "START", history: [], wheelAngle: 330, decisionIndex: 0,
    timerSeconds: 0, timerRunning: false, timerIntervalId: null
};

// 3. DOM CACHE
const knob = document.getElementById('knob');
const wheelLayer = document.getElementById('wheel-layer');
const activeSlot = document.getElementById('active-slot');
const topZone = document.getElementById('zone-top');
const bottomZone = document.getElementById('zone-bottom');
const checklistUI = document.getElementById('checklist-ui');
const timerDisplay = document.getElementById('global-timer');

// 4. COORDINATE SYSTEM MATH (The Fix)
// 0 deg = 12 o'clock (Top). Clockwise.
// We need to convert Design Degrees (Top=0) to Math Degrees (Right=0)
function designDegToXY(designDeg, radius) {
    const mathDeg = designDeg - 90; // Rotate -90 degrees
    const rad = mathDeg * (Math.PI / 180);
    return { x: radius * Math.cos(rad), y: radius * Math.sin(rad) };
}

function xyToDesignDeg(x, y, centerX, centerY) {
    const dx = x - centerX;
    const dy = y - centerY;
    let mathDeg = Math.atan2(dy, dx) * (180 / Math.PI);
    let designDeg = mathDeg + 90; // Rotate back +90
    if (designDeg < 0) designDeg += 360;
    return designDeg;
}

function updateKnobPosition(designDeg) {
    const wheelRect = wheelLayer.getBoundingClientRect();
    const radius = wheelRect.width / 2;
    const { x, y } = designDegToXY(designDeg, radius);
    
    // x,y are relative to center (0,0). Add radius to place in div coordinates.
    knob.style.left = (radius + x) - 18 + 'px'; // -18 is half knob width
    knob.style.top = (radius + y) - 18 + 'px';
}

function snapKnobToRest() {
    const target = state.currentId === "START" ? 330 : 270;
    state.wheelAngle = target;
    updateKnobPosition(target);
}

// 5. RENDERER
function render() {
    const card = DECK[state.currentId];

    // Middle Card
    let tools = card.type !== 'cover' ? `
        <svg class="icon-overlay icon-bl"><use href="#icon-toolbox"></use></svg>
        <svg class="icon-overlay icon-tr" onclick="toggleFullscreen()"><use href="#icon-fullscreen"></use></svg>
    ` : '';
    let cardClass = card.type === 'cover' ? 'cover-mode' : 'card-active';

    activeSlot.innerHTML = `
        <div class="card ${cardClass}" id="active-card" style="pointer-events:auto;">
            <div class="card-header">${card.title}</div>
            <div class="card-body" style="white-space: pre-line">${card.body}</div>
            ${tools}
        </div>
    `;

    // Active Card Gestures
    const activeEl = document.getElementById('active-card');
    activeEl.addEventListener('touchstart', handleSwipeStart, {passive:true});
    activeEl.addEventListener('touchend', (e) => handleSwipeEnd(e, false), {passive:true});

    // Top Zone (Preview / Miracle Carousel)
    topZone.innerHTML = '';
    if (card.type === 'decision') {
        renderDecisionCarousel(card);
    } else if (card.next) {
        // Build stack
        let stack = [];
        let id = card.next;
        for(let i=0; i<3 && id && DECK[id]; i++) {
            stack.push(DECK[id]);
            id = DECK[id].next || (DECK[id].options ? DECK[id].options[0].next : null);
        }
        
        stack.reverse().forEach((c, idxFromBack) => {
            const depth = stack.length - 1 - idxFromBack;
            const offset = depth * 10;
            const scale = 0.95 - (depth * 0.05);
            const icon = c.type === 'decision' ? `<svg class="icon-overlay icon-tl"><use href="#icon-decision-upper"></use></svg>` : '';
            
            const el = document.createElement('div');
            el.className = 'card card-preview';
            el.innerHTML = `<div class="card-header">${c.title}</div>${icon}`;
            el.style.zIndex = 10 - depth;
            el.style.transform = `translateY(${offset}px) scale(${scale})`;
            el.style.marginBottom = '-120px'; // Visual overlap
            
            if (depth === 0) { // Front card
                el.addEventListener('touchstart', handleSwipeStart, {passive:true});
                el.addEventListener('touchend', (e) => handleSwipeEnd(e, false), {passive:true});
            }
            topZone.appendChild(el);
        });
    }

    // Bottom Zone (History)
    bottomZone.innerHTML = '';
    if (state.history.length > 0) {
        const last = DECK[state.history[state.history.length-1]];
        const el = document.createElement('div');
        el.className = 'card card-history';
        el.innerHTML = `<div class="card-header">${last.title}</div>`;
        el.style.marginTop = '-60px';
        bottomZone.appendChild(el);
    }

    // Checklist
    checklistUI.innerHTML = '';
    (card.checklist || []).forEach(txt => {
        checklistUI.innerHTML += `<div class="checklist-item"><input type="checkbox"><span>${txt}</span></div>`;
    });
}

function renderDecisionCarousel(card) {
    card.options.forEach((opt, idx) => {
        const selected = idx === state.decisionIndex;
        const xOffset = (idx - state.decisionIndex) * 140;
        const scale = selected ? 1.0 : 0.85;
        const opacity = selected ? 1.0 : 0.5;
        
        const el = document.createElement('div');
        el.className = `card card-preview decision-option ${selected ? 'selected' : 'flank'}`;
        el.innerHTML = `<div class="card-header">OPTION</div><div class="card-body">${opt.label}</div>`;
        el.style.position = 'absolute';
        el.style.bottom = '20px';
        el.style.transform = `translateX(${xOffset}px) scale(${scale})`;
        el.style.opacity = opacity;
        
        el.onclick = () => { state.decisionIndex = idx; render(); };
        if(selected) {
            el.addEventListener('touchstart', handleSwipeStart, {passive:true});
            el.addEventListener('touchend', (e) => handleSwipeEnd(e, true, opt.next), {passive:true});
        }
        topZone.appendChild(el);
    });
}

// 6. INTERACTION LOGIC
let isDragging = false;
knob.addEventListener('mousedown', (e) => { isDragging = true; e.preventDefault(); });
document.addEventListener('mousemove', handleDrag);
document.addEventListener('mouseup', () => { isDragging = false; snapKnobToRest(); });

knob.addEventListener('touchstart', (e) => { isDragging = true; e.preventDefault(); }, {passive:false});
document.addEventListener('touchmove', handleDrag, {passive:false});
document.addEventListener('touchend', () => { isDragging = false; snapKnobToRest(); });

function handleDrag(e) {
    if (!isDragging) return;
    e.preventDefault();
    
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    
    const rect = wheelLayer.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;
    
    const newDeg = xyToDesignDeg(clientX, clientY, cx, cy);
    updateKnobPosition(newDeg);
    
    // LOGIC: Anticlockwise Pull
    // From 330 (11:00) -> 270 (9:00). Positive delta if wrapping logic handled.
    // Actually, simply checking if we cross 270 threshold from the "Right" side.
    
    const prev = state.wheelAngle;
    
    if (DECK[state.currentId].type === 'decision') {
        // Miracle Logic: Horizontal toggle around 9 o'clock
        if (newDeg > 220 && newDeg < 320) {
            const idx = newDeg < 270 ? 0 : 1;
            if (idx !== state.decisionIndex) {
                state.decisionIndex = idx;
                render();
                if(navigator.vibrate) navigator.vibrate(10);
            }
        }
    } else {
        // Standard Transition
        // Detect crossing 270 going Anticlockwise (300 -> 270)
        if (prev > 280 && newDeg < 270 && newDeg > 180) triggerNext();
        // Detect Backwards (250 -> 270 -> 300)
        else if (prev < 260 && prev > 180 && newDeg > 270) triggerBack();
    }
    
    state.wheelAngle = newDeg;
}

function triggerNext(forcedId) {
    const curr = DECK[state.currentId];
    const next = forcedId || curr.next;
    if (!next || !DECK[next]) return;
    
    state.history.push(state.currentId);
    state.currentId = next;
    state.decisionIndex = 0;
    startTimer();
    render();
    snapKnobToRest();
}

function triggerBack() {
    if (state.history.length === 0) return;
    state.currentId = state.history.pop();
    state.decisionIndex = 0;
    render();
    snapKnobToRest();
}

// Swipe
let startY = 0;
function handleSwipeStart(e) { startY = e.touches[0].clientY; }
function handleSwipeEnd(e, isDecision, nextId) {
    const dY = e.changedTouches[0].clientY - startY;
    if (dY > 50) isDecision ? triggerNext(nextId) : triggerNext();
    else if (dY < -50) triggerBack();
}

// Timer
function startTimer() {
    if (state.timerRunning) return;
    state.timerRunning = true;
    state.timerIntervalId = setInterval(() => {
        state.timerSeconds++;
        const h = String(Math.floor(state.timerSeconds/3600)).padStart(2,'0');
        const m = String(Math.floor((state.timerSeconds%3600)/60)).padStart(2,'0');
        const s = String(state.timerSeconds%60).padStart(2,'0');
        timerDisplay.textContent = `${h}:${m}:${s}`;
    }, 1000);
}

// Settings Long Press
let pressTimer;
const title = document.getElementById('header-title');
title.addEventListener('mousedown', () => pressTimer = setTimeout(() => document.getElementById('dev-settings').style.display='block', 2000));
title.addEventListener('mouseup', () => clearTimeout(pressTimer));
title.addEventListener('touchstart', () => pressTimer = setTimeout(() => document.getElementById('dev-settings').style.display='block', 2000));
title.addEventListener('touchend', () => clearTimeout(pressTimer));

function setVar(n, v) { document.documentElement.style.setProperty(n, v); }
function toggleFullscreen() { document.getElementById('app-frame').classList.toggle('fs'); }

// Init
render();
updateKnobPosition(330);

</script>
</body>
</html>